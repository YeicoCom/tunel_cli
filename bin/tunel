#!/bin/bash -e

SCRIPT_PATH=$(dirname $BASH_SOURCE)
SCRIPT_PATH=$(realpath $SCRIPT_PATH)

panic() { 
    >&2 echo Panic: $@
    exit 1
}

no_output() {
    $@ 2>/dev/null >/dev/null
}

no_error() {
    $@ 2>/dev/null
}

help() {
    this=$(basename $0)
    echo "Usage: $this action ...args"
    echo "$this help"
    echo "$this sessions"
    echo "$this login <email>"
    echo "$this logout <email>"
    echo "$this list_servers"
    echo "$this list_shares <server_id>"
    echo "$this add_server"
    echo "#use @ for empty name/network"
    echo "$this update_server <server_id> <name> <network>"
    echo "$this delete_server <server_id> <host_uuid>"
    exit 1
}

API="https://dash.tunel.mx/api"
DIR=~/.tunelmx

require() {
    CMD=$1
    shift
    no_output whereis $CMD || panic "$CMD is required $@"
}

check_deps() {
    no_output mkdir -p $DIR/sessions
    no_output mkdir -p $DIR/servers
    no_output mkdir -p $DIR/clients
    no_output mkdir -p $DIR/tmp
    require asdf
    require curl   
    require sed   
}

check_default_session() {
    EMAIL=$(no_error cat $DIR/email)
    [ -f $DIR/sessions/$EMAIL ] || return 1
    check_session $EMAIL
}

panic_if_no_session() {
    check_default_session || panic Not logged in
    EMAIL=$(cat $DIR/email)
    TOKEN=$(cat $DIR/sessions/$EMAIL)
    echo Current session: $EMAIL
}

panic_if_arg_empty() {
    NAME=$1
    VALUE=$2
    [ "$VALUE" != "" ] || panic Argument \<$NAME\> is required
}

check_session() {
    EMAIL=$1
    FILE=$DIR/sessions/$EMAIL
    [ -f $FILE ] || return 1
    TOKEN=$(cat $FILE)
    RESULT=$(no_error curl $API/session/$EMAIL/$TOKEN)
    [ "$RESULT" == "ok" ] || return 1
    echo $EMAIL > $DIR/email
}

login_otac() {
    EMAIL=$1
    TOKEN=$(no_error curl $API/login/$EMAIL)
    echo "A 6 digit access has been sent to your inbox"
    echo -n "Code: "
    read CODE
    TOKEN=$(no_error curl $API/login/$EMAIL/$TOKEN/$CODE)
    FILE=$DIR/sessions/$EMAIL
    echo $TOKEN > $FILE
}

sessions() {
    EMAIL=$(no_error cat $DIR/email)
    for s in $(ls $DIR/sessions/*); do
        s=$(basename $s)
        [ "$EMAIL" == "$s" ] && echo -n '[x] '
        [ "$EMAIL" == "$s" ] || echo -n '[ ] '
        echo $s
    done
}

login() {
    panic_if_arg_empty email $1
    EMAIL=$1
    check_session $EMAIL || login_otac $EMAIL
    check_session $EMAIL || panic Login failed
    echo Login success
}

logout() {
    panic_if_arg_empty email $1
    EMAIL=$1
    FILE=$DIR/sessions/$EMAIL
    [ -f $FILE ] || panic Not logged in
    TOKEN=$(cat $FILE)
    RESULT=$(no_error curl $API/logout/$TOKEN)
    [ "$RESULT" == "ok" ] || panic Not logged in
    no_output rm -fr $FILE
    echo Logout success
}

list_servers() {
    no_error curl $API/list/$EMAIL/$TOKEN
}

list_shares() {
    panic_if_arg_empty server_id $1
    SERID=${1:-0}
    no_error curl $API/list/$EMAIL/$TOKEN/$SERID
}

add_server() {
    FILE=$DIR/tmp/server.props
    no_error curl $API/add/$EMAIL/$TOKEN > $FILE
    source $FILE
    sed -i '/HUUID/d' $FILE
    FOLDER=$DIR/servers/$SERID
    mkdir -p $FOLDER
    mv $FILE $FOLDER/
    echo $HUUID > $FOLDER/host.uuid
}

update_server() {
    panic_if_arg_empty server_id $1
    panic_if_arg_empty name $2
    panic_if_arg_empty network $3
    SERID=${1:-0}
    NAME=${2:-@}
    NETWORK=${3:-@}
    no_error curl $API/update/$EMAIL/$TOKEN/$SERID/$NAME/$NETWORK
}

delete_server() {
    panic_if_arg_empty server_id $1
    panic_if_arg_empty host_uuid $2
    SERID=${1:-0}
    SUUID=${2:-SUUID}
    no_error curl $API/delete/$EMAIL/$TOKEN/$SERID/$SUUID  
}

ACTION=$1

case $ACTION in
    update)
    asdf uninstall tunel_cli main
    asdf install tunel_cli main
    ;;
    sessions|login|logout)
    check_deps
    $@
    ;;
    list_servers|list_shares)
    check_deps
    panic_if_no_session
    $@
    ;;
    add_server|update_server|delete_server)
    check_deps
    panic_if_no_session
    $@
    ;;
    *)
    help $@
    ;;
esac
